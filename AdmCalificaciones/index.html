<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Calificaciones</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<!-- Añade este div para el contenedor de alertas -->
<div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

<div class="container">
    <h2 class="my-4">Gestión de Calificaciones</h2>
    
    <!-- Botón para abrir el modal de agregar estudiante -->
    <button class="btn btn-success mb-3" data-toggle="modal" data-target="#addModal">Agregar Calificación</button>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Estudiante</th>
                <th>Materia</th>
                <th>Calificación</th>
                <th>Tipo de evaluación</th>
                <th>Acta</th>
                <th>Grupo</th>
                <th>Periodo</th>
                <th>Editar</th>
                <th>Eliminar</th>
            </tr>
        </thead>
        <tbody>
            <!-- Aquí se llenarán los datos desde PHP -->
        </tbody>
    </table>
</div>

<!-- Modal para Agregar Estudiante -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Agregar Calificación</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="addEstudiante">Estudiante</label>
                        <select class="form-control" id="addEstudiante" name="id_estudiante" required>
                            <!-- Se llenarán las opciones dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addMateria">Materia</label>
                        <select class="form-control" id="addMateria" name="id_materia" required>
                            <!-- Se llenarán las opciones dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addCalificacion">Calificación</label>
                        <input type="number" class="form-control" id="addCalificacion" name="calificacion" min="1.0" max="10.0" required>
                    </div>
                    <div class="form-group">
                        <label for="addTipoEvaluacion">Tipo de evaluación</label>
                        <select class="form-control" id="addTipoEvaluacion" name="id_tipo_evaluacion" required>
                            <!-- Se llenarán las opciones dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addActa">Acta</label>
                        <input type="text" class="form-control" id="addActa" name="numero_acta" required>
                    </div>
                    <div class="form-group">
                        <label for="addGrupo">Grupo</label>
                        <select class="form-control" id="addGrupo" name="id_grupo" required>
                            <!-- Se llenarán las opciones dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addPeriodo">Periodo</label>
                        <select class="form-control" id="addPeriodo" name="id_periodo" required>
                            <!-- Se llenarán las opciones dinámicamente -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Calificación</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Editar Estudiante -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Calificación</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editEstudiante">Estudiante</label>
                        <select class="form-control" id="editEstudiante" required>
                            <!-- Se llenarán las carreras dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMateria">Materia</label>
                        <select class="form-control" id="editMateria" required>
                            <!-- Se llenarán las carreras dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCalificacion">Calificación</label>
                        <input type="text" class="form-control" id="editCalificacion" required>
                    </div>
                    <div class="form-group">
                        <label for="editTipoEvaluacion">Tipo de evaluación</label>
                        <select class="form-control" id="editTipoEvaluacion" required>
                            <!-- Se llenarán las carreras dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editActa">Acta</label>
                        <input type="text" class="form-control" id="editActa" required>
                    </div>
                    <div class="form-group">
                        <label for="editGrupo">Grupo</label>
                        <select class="form-control" id="editGrupo" required>
                            <!-- Se llenarán las carreras dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPeriodo">Periodo</label>
                        <select class="form-control" id="editPeriodo" required>
                            <!-- Se llenarán las retículas dinámicamente -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Confirmar Eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar esta calificación?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarEliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Añade el script de notificaciones -->
<script src="notificaciones.js"></script>
<script>
let calificacionAEliminar = null;

$(document).ready(function() {
    // Cargar estudiantes para los dropdowns
    cargarEstudiantes();

    // Cargar materias para los dropdowns
    cargarMaterias();
    
    // Cargar tipos evaluaciones para los dropdowns
    cargarTiposEvaluaciones();

    // Cargar grupos para los dropdowns
    cargarGrupos();

    // Cargar periodos para los dropdowns
    cargarPeriodos();
    
    // Cargar calificaciones
    cargarCalificaciones();

    // Manejo de agregar calificación
    $('#addForm').on('submit', function(e) {
        e.preventDefault();

        const formData = {
            id_estudiante: $('#addEstudiante').val(),
            id_materia: $('#addMateria').val(),
            calificacion: $('#addCalificacion').val(),
            id_tipo_evaluacion: $('#addTipoEvaluacion').val(),
            numero_acta: $('#addActa').val(),
            id_grupo: $('#addGrupo').val(),
            id_periodo: $('#addPeriodo').val()
        };

        $.ajax({
        url: 'create.php',
        type: 'POST',
        data: formData,
        dataType: 'json',
        success: function(response) {
            if (response.status === 'success') {
                mostrarMensaje(response.message, response.status === 'success' ? 'success' : 'error');
                $('#addModal').modal('hide');
                cargarCalificaciones();
            } else {
                mostrarMensaje('Error al agregar la calificación: ' + response.message);
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log("Error:", textStatus, errorThrown);
            mostrarMensaje("Error en la creación de la calificación: " + jqXHR.responseText);
        }
    });
});

    // Manejo de editar estudiante
    $('#editForm').on('submit', function(e) {
        e.preventDefault();

        const id_calificacion = $(this).data('id_calificacion');
        const formData = {
            id_calificacion: id_calificacion,
            id_estudiante: $('#editEstudiante').val(),
            id_materia: $('#editMateria').val(),
            calificacion: $('#editCalificacion').val(),
            id_tipo_evaluacion: $('#editTipoEvaluacion').val(),
            numero_acta: $('#editActa').val(),
            id_grupo: $('#editGrupo').val(),
            id_periodo: $('#editPeriodo').val()
        };

        $.ajax({
            url: 'update.php',
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    mostrarMensaje(response.message, response.status === 'success' ? 'success' : 'error');
                    $('#editModal').modal('hide');
                    cargarCalificaciones();
                } else {
                    mostrarMensaje('Error al actualizar la calificación', 'error');
                }
            },
            error: function() {
                mostrarMensaje("Error en la actualización de la calificación.", 'error');
            }
        });
    });

    // Confirmación de eliminación
    $('#confirmarEliminar').click(function() {
        if (calificacionAEliminar) {
            $.ajax({
                url: 'delete.php',
                type: 'POST',
                data: { id_calificacion: calificacionAEliminar },
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'success') {
                        mostrarMensaje(response.message, 'success');
                        $('#deleteModal').modal('hide');
                        cargarCalificaciones();
                    } else {
                        mostrarMensaje('Error al eliminar la calificación', "error");
                    }
                },
                error: function() {
                    mostrarMensaje("Error al eliminar la calificación.", "error");
                }
            });
        }
    });

    $('#deleteModal').on('hidden.bs.modal', function () {
        calificacionAEliminar = null;
    });
});

function cargarEstudiantes() {
    $.ajax({
        url: '../AdmEstudiantes/read.php', // Asume que está en un directorio de Carreras
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            let estudiantesHTML = '<option value="">Seleccione una opción</option>';
            data.forEach(estudiante => {
                estudiantesHTML += `<option value="${estudiante.idE}">${estudiante.nombre}</option>`;
            });
            $('#addEstudiante, #editEstudiante').html(estudiantesHTML);
        },
        error: function() {
            mostrarMensaje("Error al cargar los estudiantes.", "error");
        }
    });
}

function cargarMaterias() {
    $.ajax({
        url: '../AdmMaterias/read.php', // Asume que está en un directorio de Carreras
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            let materiasHTML = '<option value="">Seleccione una opción</option>';
            data.forEach(materia => {
                materiasHTML += `<option value="${materia.id_materia}">${materia.nombre_materia}</option>`;
            });
            $('#addMateria, #editMateria').html(materiasHTML);
        },
        error: function() {
            mostrarMensaje("Error al cargar las materias.", "error");
        }
    });
}

function cargarTiposEvaluaciones() {
    $.ajax({
        url: '../AdmCalificaciones/get_tipoevaluacion.php',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log("Respuesta del servidor:", data);
            let tiposEvaluacionHTML = '<option value="">Seleccione una opción</option>';
            data.forEach(tipo => {
                tiposEvaluacionHTML += `<option value="${tipo.id_tipo_evaluacion}">${tipo.tipo}</option>`;
            });
            $('#addTipoEvaluacion').html(tiposEvaluacionHTML);
        },
        error: function(xhr, status, error) {
            console.log("Error:", xhr.responseText);
            mostrarMensaje("Error al cargar los tipos de evaluación.", "error");
        }
    });
}

function cargarGrupos() {
    $.ajax({
        url: '../AdmCalificaciones/get_grupo.php', // Ajusta la ruta según la estructura de tu proyecto
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            let gruposHTML = '<option value="">Seleccione un grupo</option>';
            data.forEach(grupo => {
                gruposHTML += `<option value="${grupo.id_grupo}">${grupo.nombre_grupo}</option>`;
            });
            $('#addGrupo').html(gruposHTML);
        },
        error: function(xhr, status, error) {
            console.log("Error:", xhr.responseText);
            mostrarMensaje("Error al cargar los grupos.", "error");
        }
    });
}

function cargarPeriodos() {
    $.ajax({
        url: '../AdmCalificaciones/get_periodo.php', // Ajusta la ruta si es necesario
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            let periodosHTML = '<option value="">Seleccione un periodo</option>';
            data.forEach(periodo => {
                periodosHTML += `<option value="${periodo.id_periodo}">${periodo.periodo}</option>`;
            });
            $('#addPeriodo').html(periodosHTML);
        },
        error: function(xhr, status, error) {
            console.log("Error:", xhr.responseText);
            mostrarMensaje("Error al cargar los periodos.", "error");
        }
    });
}

function cargarCalificaciones() {
    $.ajax({
        url: 'read.php',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log("Datos recibidos:", data);  // Log detallado de los datos
            
            // Verificar si data es un array
            if (!Array.isArray(data)) {
                console.error("Los datos recibidos no son un array:", data);
                mostrarMensaje("Error: Los datos recibidos no tienen el formato esperado", "error");
                return;
            }

            // Verificar si hay datos
            if (data.length === 0) {
                console.warn("No se recibieron calificaciones");
                $('table tbody').html('<tr><td colspan="9">No hay calificaciones para mostrar</td></tr>');
                return;
            }

            let calificacionesHTML = '';
            data.forEach(calificacion => {
                console.log("Calificación individual:", calificacion);  // Log de cada calificación
                calificacionesHTML += `
                    <tr>
                        <td>${calificacion.nombre_estudiante || 'N/A'} ${calificacion.apellido_paterno || ''} ${calificacion.apellido_materno || ''}</td>
                        <td>${calificacion.nombre_materia || 'N/A'}</td>
                        <td>${calificacion.calificacion || 'N/A'}</td>
                        <td>${calificacion.nombre_tipo_evaluacion || 'N/A'}</td>
                        <td>${calificacion.numero_acta || 'N/A'}</td>
                        <td>${calificacion.nombre_grupo || 'Sin grupo'}</td>
                        <td>${calificacion.nombre_periodo || 'Sin periodo'}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editModal" 
                                    onclick="editarCalificacion(${calificacion.id_calificacion})">
                                Editar
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteModal" 
                                    onclick="eliminarCalificacion(${calificacion.id_calificacion})">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            });
            $('table tbody').html(calificacionesHTML);
        },
        error: function(xhr, status, error) {
            console.error("Error completo: ", xhr);
            console.log("Detalles del error: ", xhr.responseText);
            
            // Mostrar el mensaje de error en la tabla
            $('table tbody').html(`
                <tr>
                    <td colspan="9" class="text-danger">
                        Error al cargar calificaciones: ${error}
                        <br>Detalles: ${xhr.responseText}
                    </td>
                </tr>
            `);
        }
    });
}

function editarCalificacion(id_calificacion) {
    console.log("ID de calificación a editar:", id_calificacion);
    
    // Primero, cargar los dropdowns
    $.when(
        $.ajax({
            url: '../AdmCalificaciones/get_tipoevaluacion.php',
            type: 'GET',
            dataType: 'json'
        }),
        $.ajax({
            url: '../AdmCalificaciones/get_grupo.php',
            type: 'GET',
            dataType: 'json'
        }),
        $.ajax({
            url: '../AdmCalificaciones/get_periodo.php',
            type: 'GET',
            dataType: 'json'
        })
    ).then(function(tiposEvaluacionResp, gruposResp, periodosResp) {
        // Llenar los dropdowns
        let tiposEvaluacionHTML = '<option value="">Seleccione una opción</option>';
        tiposEvaluacionResp[0].forEach(tipo => {
            tiposEvaluacionHTML += `<option value="${tipo.id_tipo_evaluacion}">${tipo.tipo}</option>`;
        });
        $('#editTipoEvaluacion').html(tiposEvaluacionHTML);

        let gruposHTML = '<option value="">Seleccione un grupo</option>';
        gruposResp[0].forEach(grupo => {
            gruposHTML += `<option value="${grupo.id_grupo}">${grupo.nombre_grupo}</option>`;
        });
        $('#editGrupo').html(gruposHTML);

        let periodosHTML = '<option value="">Seleccione un periodo</option>';
        periodosResp[0].forEach(periodo => {
            periodosHTML += `<option value="${periodo.id_periodo}">${periodo.periodo}</option>`;
        });
        $('#editPeriodo').html(periodosHTML);

        // Luego cargar los datos de la calificación
        $.ajax({
            url: 'get_calificaciones.php',
            type: 'GET',
            data: { id_calificacion: id_calificacion },
            dataType: 'json',
            success: function(response) {
                console.log("Respuesta completa del servidor:", response);
                
                if (response.status === 'success') {
                    const calificacion = response.data;
                    console.log("Datos de la calificación:", calificacion);
                    
                    // Llenar los campos del modal de edición
                    $('#editEstudiante').val(calificacion.id_estudiante);
                    $('#editMateria').val(calificacion.id_materia);
                    $('#editCalificacion').val(calificacion.calificacion);
                    $('#editTipoEvaluacion').val(calificacion.id_tipo_evaluacion);
                    $('#editActa').val(calificacion.numero_acta);
                    $('#editGrupo').val(calificacion.id_grupo);
                    $('#editPeriodo').val(calificacion.id_periodo);

                    $('#editForm').data('id_calificacion', calificacion.id_calificacion);
                    
                    // Abrir el modal de edición
                    $('#editModal').modal('show');
                } else {
                    console.error("Error en la respuesta del servidor:", response.message);
                    mostrarMensaje("Error al cargar los datos de las calificaciones: " + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error completo:", xhr);
                console.log("Status:", status);
                console.log("Error:", error);
                console.log("Respuesta del servidor:", xhr.responseText);
                
                mostrarMensaje("Error en la solicitud de datos de las calificaciones. Revise la consola para más detalles.", "error");
            }
        });
    }).fail(function() {
        mostrarMensaje("Error al cargar los datos para el modal de edición.", "error");
    });
}

function eliminarCalificacion(id_calificacion) {
    calificacionAEliminar = id_calificacion;
}
</script>
</body>
</html>